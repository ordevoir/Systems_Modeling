# Simplest Environment with PyGame

Создадим простейшую среду  с визуализацией через PyGame, используя Parallel API, на основе этого [tutorial](https://pettingzoo.farama.org/tutorials/custom_environment/) (в котором нет PyGame). Так же можно посмотреть [этот образец для создания среды](https://pettingzoo.farama.org/content/environment_creation/).

## Project Structure

Рекомендуемая структура проекта:

```
Simplest-Environment
├── simplest-environment
    └── env
        └── simplest_environment.py
    └── simplest_environment_v0.py
├── README.md
└── requirements.txt
```

В `env` сохраняется среда, вместе со всеми вспомогательными функциями. Файл `simplest_environment_v0.py` импортирует среду – имя файла используется для контроля версии. В `requirements.txt` отслеживаются зависимости среды. Как минимум, здесь должен быть `pettingzoo`. Рекомендуется указывать версии зависимостей через `==`.

>готовая к установке среда также должна содержать [дополнительные файлы](https://pettingzoo.farama.org/tutorials/custom_environment/1-project-structure/#advanced-additional-optional-files)

Вся логика среды должна храниться в директории `env`.

Сама среда представляет собой класс, в котором определено поле класса `metaclass` (словарь), и некоторой набор публичных методов:


```python
from pettingzoo import ParallelEnv

class raw_env(ParallelEnv):
    metadata = {
        "name": "simplest_environment_v0",
    }

    def __init__(self):
        pass

    def reset(self, seed=None, options=None):
        pass

    def step(self, actions):
        pass

    def render(self):
        pass

    def observation_space(self, agent):
        return self.observation_spaces[agent]

    def action_space(self, agent):
        return self.action_spaces[agent]
```

## Environment Logic

Создадим среду с двумя агентами: `prisoner` и `guard`. Первый пытается сбежать в `escape`, а второй должен его перехватить. Среда представляет собой сетку $m \times m$, в которой:

- `prisoner` стартует в левом верхнем углу,
- `guard` стартует в правом нижнем углу,
- `escape` случайным образом располагается в средней части сетки.
- оба агента могут двигаться одном из четырех направлений (`up`, `down`, `left`, `right`).

### `metadata`

Поле класса `metadata` хранит константы среды.

### `__init__()`

Конструктор принимает аргументы среды, к примеру, режим отрисовки `render_mode`. 

### `reset()`

Метод производит сброс к стартовой точке, а в начале игры – производит инициализацию атрибутов так, чтобы при вызове методов `render()`, `step()` и `observe()` не возникало проблем. В нашей среде необходимо инициализировать следующие атрибуты:

    - agents
    - timestamp
    - prisoner x and y coordinates
    - guard x and y coordinates
    - escape x and y coordinates
    - observation
    - infos

Список агентов `agents` копируется из `possible_agents` и в общем случае может меняться в процессе игры, хотя в данной среде такое не предусмотренно.

Метод должен возвращать два объекта `observations, infos`, и даже если информация не предполагается, следует возвращать некоторый фиктивный объект для конвертации `parallel_to_aec`.

### `step()`

В методе производится выбор действия для текущего агента (который определяется классом `agent_selection`). Метод принимает словарь `agent: action`, в котором определены действия для соответствующих агентов.

Метод выполняет выбранные извне действия, т.е. в соответствтии с этими действиями, необходимо обновить среду:

    - prisoner x and y coordinates
    - guard x and y coordinates
    - terminations
    - truncations
    - rewards
    - timestamp
    - infos

а также все внутренние состояния, которые используются методами `observe()` и `render()`.

При этом необходимо проверять некоторые условия:
- первым делом проверяются **termination conditions** для каждого агента; условие завершения агента определяются дизайном игры;
- вторым делом проверяются **truncation conditions** – условие искусственного завершения игры, обычно, когда превышего максимальное число шагов, ограничение по времени, или же исчерпание всех ресурсов. 

Метод `step()` должен возвращать пять объектов: `observations, rewards, terminations, truncations, infos`.

В данном случае мы также используем маскирование действий (`action masking`), так как доступность тех или иных действий может ограничиваться состоянием среды. Подробнее это описано ниже (Action Masking).

### `render()`

В этом методе производится визуализация среды.

### `observation_space()` & `action_space()`

Метод `observation_space()` должен возвращать пространство наблюдений агента, имя которого передано в качестве аргумента. 

Метод `action_space()` должен возвращать пространство действия агента, имя которого передано в качестве аргумента.

Пространства в gymnasium описанны [здесь](https://gymnasium.farama.org/api/spaces/). Здесь мы использовали классы `Discrete` и `MultiDiscrete` из `gymnasium.spaces`.

Декоратор `lru_cache` из `functools` позволяют произвести мемоизацию пространств наблюдений и действий, сокращая такт циклов, требующих получаения пространств от каждого агента.


## Action Masking

Как вариант, можно было бы проверять на месте, прежде чем менять среду, являются ли выбранные действия для агентов валидными, и уже исходя из этого менять или не менять среду. Но более естественный способ – передавать в словаре `observations` маску действий. Это позволит обрабатывать недопустимые действия снаружи.

Для этого, после того, создается массив из единиц, длина которого равна числу всевозможных действий агента. Далее, в зависимости от расположения агента (после совершения текущего действия), необходимо указать действия, которые будут выводить за пределы сетки. В данной среде 4 всевозможных действия кодируются значениями из множества $\{0, 1, 2, 3\}$. Для недопустимых действий в маскировочном массиве устанавливается значение 0 под соответствующим индексом.

В нашей среде генерируются две маски `prisoner_action_mask` и `guard_action_mask`. Эти массивы размещаются под ключом `"action_mask"` в словарях соответствующих агентов.

## Testing Environment

Для тестирования можно добавить в конце файла следующий код:

```python
from pettingzoo.test import parallel_api_test

if __name__ == "__main__":
    env = raw_env()
    parallel_api_test(env, num_cycles=1_000_000)
```

   


